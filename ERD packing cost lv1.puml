@startuml
hide circle
skinparam classAttributeIconSize 0
skinparam linetype ortho

package "Master Data" as master_domain #DDD {

    entity "Currency" as currency {
        currency_code : char(3) <<PK>>
        --
        name : varchar(25) NOT NULL
        country_code : char(4) NOT NULL <<FK>>
    }

    entity "ExchangeRate" as exc_rate {
        exc_rate_code : char(18) <<PK>>
        --
        start_periode : timestamp
        end_periode : timestamp
        currency_code_source : char(3) <<FK>>
        currency_code_target : char(3) <<FK>>
        rate : numeric(15,2)
    }

    exc_rate ||--|{ currency

    entity "Country" as country {
        country_code : char(4) <<PK>>
        three_digits_country_code : char(3) <<PK>>
        --
        country_name : varchar(100) NOT NULL
    }

    entity "ReportingPeriod" as rp {
        reporting_periode_code : char(6) <<PK>>
        --
    }

    entity "MasterParam" as mp {
        reporting_periode_code : varchar(6) <<PK>> <<FK>>
        --
        param_name : varchar(50) NOT NULL
        param_type : smallint NOT NULL <<ENUM: 0:manhour|1:inland|3:labor>>
        value : numeric(15,2) NOT NULL
    }

    'package SupplierDomain #DDD {
    entity "Supplier" as supplier {
        supplier_code : char(6) <<PK>>
        --
        name : varchar(255) NOT NULL
        address : varchar(255) NULLABLE
    }

    entity "Plant" as plant {
        plant_code : varchar(10) <<PK>>
        --
    }

    entity "Dock" as dock {
        dock_code : varchar(10) <<PK>>
        --
    }
    
    rp ||--o{ mp : has many

}

package "Packing Spec" as ps_domain #DDD {

    entity "Project" as project {
        project_code : char(6) <<PK>>
        --
        name : varchar(64) NULLABLE
        description : varchar(256) NULLABLE
        manager : varchar(10) NULLABLE <<FK>>
        implementation_period : varchar(6) NOT NULL
        status : tinyint NOT NULL <<ENUM: 0:Draft|1:Active|2:OnHold|3:Completed>> <<DEFAULT 1>>
        note : varchar(1000) NULLABLE
    }

    entity "Model" as model {
        model_code : char(6) <<PK>>
        --
        name : varchar(100) NULLABLE
        remark : varchar(255) NULLABLE
        country_code : char(4) NOT NULL <<FK>>
        project_code : char(6) NOT NULL <<FK>>
    }

    entity "Part" as part {
        part_no : varchar(10) <<PK>>
        --
        suffix_code : varchar(2) NOT NULL <<FK>>
        part_name : varchar(255) NOT NULL
        parent_part_no : varchar(10) NULLABLE <<FK>>
        supplier_code : varchar(10) NULLABLE <<FK>>
        dimension_length : int
        dimension_width : int
        dimension_height : int
        weight_per_pc : int
        qty_per_box : int
        total_weight : int
    }

    entity "PreparationTime" as prep_time {
        part_no : varchar(10) <<PK>> <<FK>>
        --
        boxing : int
        stacking : int
    }

    entity "Suffix" as suffix {
        suffix_code : varchar(2) <<PK>>
        --
        note : varchar(10)
    }

    entity "PackingSpec" as cps {
        cps_id : int <<PK>> <<AUTO_INCREMENT>>
        cps_code : varchar(34)
        --
        cps_code_ref : varchar(28) NULLABLE <<FK>>
        model_code : varchar(6) NOT NULL <<FK>>
        part_no : varchar(12) NOT NULL
        is_active : boolean NOT NULL <<DEFAULT true>>
        cps_type : tinyint NOT NULL <<DEFAULT 0>>
    }
    
    note top of cps
        composite cps_code = 
          cps_type of tyoe( <<enum 0:CPS, 1:ECI, 2:PSI>>)
          cps_code generated from : dest,
          model, part_no, reporting_period
    end note
    
    entity "PackingSpecDetail" as cps_dtl {
        cps_id : int <<FK>>
        cps_code : varchar(28) <<FK>>
        packing_material_price_code : varchar(12) <<FK>>
        --
        qty : numeric(5,2) NOT NULL <<DEFAULT 1>>
    }
    
    entity "PackingSpecPseDtl" as cps_pse_dtl {
        cps_id : int <<PK>> <<AUTO_INCREMENT>>
        --
        cps_code : varchar(28) NOT NULL <<FK>>
        packing_plant_current : varchar(6) NULLABLE
        packing_plant_next : varchar(6) NULLABLE
        vanning_plant_current : varchar(6) NULLABLE
        vanning_plant_next : varchar(6) NULLABLE
        category : tinyint NULLABLE 
        importer_line_process : tinyint NULLABLE
        case_code : varchar(4) NULLABLE
        box_number : varchar(1000) NULLABLE
        renban : char(2) NULLABLE
        packing_line : varchar(4) NULLABLE
        packing_process_boxing : tinyint NULLABLE
        packing_process_stacking : tinyint NULLABLE
    }

    note top of cps_pse_dtl
      category and packing line of type 
        <<ENUM: 0:trim|1:welding|2:hardware|3:finish>>
      packing_process_boxing and packing_process_stackin of type 
        <<ENUM: 1:TMMIN | 2:supplier>>
    end note
    
    entity "PackingSpecLogisticDtl" as cps_logistic_dtl {
        cps_code : varchar(28) <<PK>> <<FK>>
        --
        dock_code :varchar(20) NULLABLE <<FK>>
        remark :varchar(1000) NULLABLE <<FK>>
        process_type : char(2) NULLABLE
        address_rack : varchar (20) NULLABLE
    }

    cps ||--o| cps_logistic_dtl : has logistic info detailed
        
    entity "PackingMaterialPrice" as material_price {
        packing_material_price_code : varchar(12) <<PK>>
        --
        reporting_periode_code : char(6) NOT NULL <<FK>>
        material_no : varchar(28) NOT NULL <<FK>>
        price : numeric(15,2) NOT NULL
    }
    
    entity "PackingSpecImage" as cps_image {
        cps_image_id : int <<PK>> <<AUTO_INCREMENT>>
        --
        cps_code : varchar(28) NOT NULL <<FK>>
        cps_image_type : tinyint NOT NULL 
        cps_image_path : varchar(1000) NOT NULL
    }
    
    note top of cps_image
      cps_image_type of type: 
        <<ENUM: 0:part, 1:qkp, 2:bkp, 3:outer, 4:inner>>
    end note
    
    entity "PackingMaterial" as material {
        material_no : varchar(12) <<PK>>
        --
        cps_code : varchar(34) <<FK>>
        packing_material_type : tinyint <<ENUM: Module|Box|Inner|Outer>>
        dimension_width : numeric(5,2) NOT NULL
        dimension_height : numeric(5,2) NOT NULL
        dimension_length : numeric(5,2) NOT NULL
        dimension_inner_width : numeric(5,2) NOT NULL
        dimension_inner_length : numeric(5,2) NOT NULL
        dimension_inner_height : numeric(5,2) NOT NULL
        dimension_outer_width : numeric(5,2) NOT NULL
        dimension_outer_length : numeric(5,2) NOT NULL
        dimension_outer_height : numeric(5,2) NOT NULL
        ewarehouse_item_no : varchar(6) NULLABLE <<FK>>
        ewarehouse_price : numeric(15,2) NULLABLE
        price : numeric(15,2) NOT NULL <<DEFAULT 0.00>>
        currency_code : char(3) NOT NULL <<FK>> <<DEFAULT 'IDR'>>
    }
    
    cps ||-o| cps_pse_dtl : has pse info detailed
    cps_pse_dtl }|--|| material : packed using 
    cps ||-o{ cps_image : has many
    cps ||-o{ cps_dtl : has many
    cps_dtl }|-o| material_price
    material ||--|{ currency : purchased in

}

package Other as other_domain #f5f5f5ff {
  package DocumentDomain #DDD {
      entity "Document" as doc {
          document_id : integer <<PK>> <<AUTO_INCREMENT>>
          --
          document_url : varchar(1000) NOT NULL
      }
  }

  package ApprovalDomain #DDD {
      entity "ApprovalRequest" as request {
          id : char(36) <<PK>> <<UUID>>
          --
          target_type : varchar(50) NOT NULL
          target_id : char(36) NOT NULL <<UUID>>
          status : tinyint NOT NULL <<ENUM: 0:pending|1:approved|2:rejected>>
          created_at : datetime NOT NULL
      }

      entity "ApprovalStep" as step {
          id : char(36) <<PK>> <<UUID>>
          --
          request_id : char(36) NOT NULL <<FK>>
          sequence : int NOT NULL
          role_required : varchar(50) NOT NULL
          status : tinyint NOT NULL <<ENUM: 0:pending|1:approved|2:rejected>>
      }

      entity "ApprovalAction" as action {
          id : char(36) <<PK>> <<UUID>>
          --
          step_id : char(36) NOT NULL <<FK>>
          user_id : varchar(10) NOT NULL <<FK>>
          action : tinyint NOT NULL <<ENUM: 0:approve|1:reject>>
          comment : text NULLABLE
          action_date : datetime NOT NULL
      }

      request ||--o{ step : has
      step ||--o{ action : has
      request ||--o{ step : has many
      request }|..|| cps : "require approval from \n(target_id = cps_code)"
  }

  package MessagingDomain #DDD {
      entity "Notification" as notif {
          notification_id : int <<PK>> <<AUTO_INCREMENT>>
          --
          user_code : varchar(10) NOT NULL <<FK>>
          title : varchar(255) NOT NULL
          message : text NOT NULL
          is_read : boolean NOT NULL <<DEFAULT false>>
          created_at : datetime NOT NULL
      }
  }
  package UserManagementDomain #DDD {
      entity "User" as user {
          user_code : varchar(10) <<PK>>
          --
          name : varchar(255) NOT NULL
          role_code : varchar(5) NOT NULL <<FK>>
      }

      entity "Department" as dept {
          dept_code : varchar(5) <<PK>>
          --
          name : varchar(100) NOT NULL
          parent_dept_code : varchar(5) NOT NULL <<FK>>
      }

      dept::parent_dept_code --> dept::dept_code

      entity "Role" as role {
          role_code : varchar(5) <<PK>>
          --
          name : varchar(100) NOT NULL
      }

      entity "DepartmentRole" as dept_role {
          dept_code : varchar(5) <<PK>> <<FK>>
          role_code : varchar(5) <<PK>> <<FK>>
          --
      }

      user ||--|| dept : "belong to"
      user }o--|| role : "is a"
      user ||--o{ notif : "receive"
      user ||--o{ action : performs
      project }o--|| user : "managed"
      request }o--|| user : "requested by"
      supplier ||--o{ user : "logged in as "
      dept_role }o--o{ role : "has many"
      dept_role }o--o{ dept : "has many"    
  }
}

' Relationships
cps ||--o| material : "packed by"

part ||--o{ part : "has subparts"
part ||--|{ suffix : has
part ||--o{ prep_time : "prepared within"

supplier ||--o{ part : "produced by"
supplier ||--|{ plant : "has"
supplier ||--|{ dock : "has"

model ||--o{ part : "consists of"
model ||--o{ project : "used in"
model ||--o{ country : "exported to"

project }o--|| dept : "belongs to"

@enduml

/'
====================
SAMPLE RECORDS
====================

---------------------------
ProductionMaster Service
---------------------------
Model
| code   | name     | generation | created_at         |
| ------ | -------- | ---------- | ------------------ |
| GGN155 | Hilux    | 8th Gen    | 2020-03-01 09:00:00 |
| TGN166 | Fortuner | 2nd Gen    | 2021-05-12 13:30:00 |

Project
| code      | name             | description          | project_manager | start_date | end_date   | status     |
| --------- | ---------------- | -------------------- | ----------------| -----------| ---------- | ---------- |
| PJ-HX2023 | Hilux 2023 TH    | Hilux 2023 Thailand  | 1               | 2022-07-01 | 2023-07-01 | Completed  |
| PJ-FT2024 | Fortuner 2024 EX | Fortuner 2024 Export | 2               | 2023-01-15 | 2024-01-15 | Active     |

ProjectModel
| project_code | model_code |
| ------------ | -----------|
| PJ-HX2023    | GGN155     |
| PJ-FT2024    | TGN166     |

Country
| code | country_name |
| ---- | -------------|
| TH   | Thailand     |
| PH   | Philippines  |

ReportingPeriod
| year | periodname |
| ---- | ---------- |
| 2025 | 03.2025    |
| 2025 | 08.2025    |
| 2024 | 08.2024    |

ManHourParams
| param_id | param_name             | value    |
| -------- | -----------------------| ---------|
| MH-001  | takt_time               | 1        |
| MH-002  | inspection_time         | 0.3125   | 2.5/8
| MH-003  | delivery_course_time    | 6        |
| MH-004  | pallet_sorting_time     | 0.3125   | 2.5/8
| MH-005  | non_pallet_sorting_time | 5.833    | 350/60
| MH-006  | vanning_time            | 0,595    | 30/(24x2.1)
| MH-007  | empty_box_return_time   | 5        |



------------------------------------
User Management Service
------------------------------------
User
| name         | role_name    |
| ------------ | ------------ |
| Aiko Tanaka  | Dept Head    |
| Budi Santoso | Staff        |

Department
| name  | full_dept_name                    | parent_dept_id |
| ----- | --------------------------------- | -------------- |
| PPM   | Production Part Mgmt              |                |
| PBOD  | Part Business Operation Division  |                |
| Proc  | Procurement                       | PBOD           |

Role
| name         | dept_id |
| ------------ | --------|
| Dept Head    | PPM     |
| Section Head | PPM     |
| Staff        | Proc    |

DepartmentRole
| dept_name | role_name    |
| --------- | ------------ |
| PPM       | Dept Head    |
| PPM       | Section Head |
| Proc      | Staff        |

----------------------------------
Packing Service
----------------------------------
PackingSpec
| spec_code   | model_code |
| ----------- | ---------- |
| PS-GGN155-01| GGN155     |
| PS-TGN166-01| TGN166     |

----------------------------------
Part Service
----------------------------------
Part
| part\_no   | suffix\_code | part\_name   | parent\_part\_no | supplier\_code | dimension\_length | dimension\_width | dimension\_height | weight\_per\_pc | qty\_per\_box | total\_weight |
| ---------- | ------------ | ------------ | ---------------- | -------------- | ----------------- | ---------------- | ----------------- | --------------- | ------------- | ------------- |
| P001000001 | 01           | Front Bumper | (null)           | SUP-001        | 150               | 40               | 35                | 12              | 5             | 60            |
| P001000002 | 02           | Rear Bumper  | P001000001       | SUP-002        | 140               | 45               | 30                | 11              | 5             | 55            |

Suffix
| suffix\_code | note   |
| ------------ | ------ |
| 01           | Black  |
| 02           | Silver |

Inhouse_price
| part\_no   | periodname | year | msp   | jsp   | local\_outhouse | tooling\_outhouse | raw\_material | labor | foh\_fixed | foh\_var | unfinished\_depre | total\_process\_cost | exclusive\_investment | total\_cost |
| ---------- | ---------- | ---- | ----- | ----- | --------------- | ----------------- | ------------- | ----- | ---------- | -------- | ----------------- | -------------------- | --------------------- | ----------- |
| P001000001 | 03.2025    | 2025 | 100.0 | 120.0 | 10.0            | 5.0               | 40.0          | 15.0  | 8.0        | 2.0      | 3.0               | 83.0                 | 7.0                   | 90.0        |
| P001000002 | 03.2025    | 2025 | 95.0  | 110.0 | 9.0             | 4.0               | 38.0          | 14.0  | 7.0        | 2.0      | 2.5               | 77.5                 | 6.5                   | 84.0        |

Outhouse_price
| part\_no   | periodname | year | source         | price  |
| ---------- | ---------- | ---- | -------------- | ------ |
| P001000001 | 03.2025    | 2025 | Aisin Seiki    | 102.00 |
| P001000002 | 03.2025    | 2025 | Toyota Boshoku | 98.50  |

====================================================
SAMPLE Records to illustrate Approval process works
====================================================

ApprovalRequest
| id (UUID) | target\_type  | target\_id (UUID) | status     | created\_at         |
| --------- | ------------- | ----------------- | ---------- | ------------------- |
| `req-001` | `PackingSpec` | `ps-789`          | `Approved` | 2025-07-17 09:00:00 |


ApprovalSteps
| id       | request\_id | sequence | role\_required | status   |
| -------- | ----------- | -------- | -------------- | -------- |
| step-001 | req-001     | 1        | `PIC`          | Approved |
| step-002 | req-001     | 2        | `Section Head` | Approved |
| step-003 | req-001     | 3        | `Dept Head`    | Approved |

ApprovalActions
| id      | step\_id | user\_id | action  | comment            | action\_date        |
| ------- | -------- | -------- | ------- | ------------------ | ------------------- |
| act-101 | step-001 | user-01  | Approve | "Looks good."      | 2025-07-17 09:05:00 |
| act-102 | step-002 | user-02  | Approve | "Reviewed and OK." | 2025-07-17 10:00:00 |
| act-103 | step-003 | user-03  | Approve | "Final approval."  | 2025-07-17 11:00:00 |

User
| id      | name    | role         |
| ------- | ------- | ------------ |
| user-01 | Alice   | PIC          |
| user-02 | Boby     | Section Head |
| user-03 | Charlie | Dept Head    |

'/